.PHONY: help build up down restart logs clean test load-sample interactive search health info

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN=\033[0;32m
YELLOW=\033[1;33m
RED=\033[0;31m
NC=\033[0m # No Color

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
SERVICE_URL=http://localhost:8000
DOCKER_COMPOSE=docker-compose

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
	@echo "$(GREEN)–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:$(NC)"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  $(YELLOW)%-15s$(NC) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

build: ## –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑—ã
	@echo "$(GREEN)–°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤...$(NC)"
	$(DOCKER_COMPOSE) build

up: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ RAG —Å–∏—Å—Ç–µ–º—ã...$(NC)"
	$(DOCKER_COMPOSE) up -d
	@echo "$(GREEN)–ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...$(NC)"
	@sleep 10
	@make health

down: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(YELLOW)–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...$(NC)"
	$(DOCKER_COMPOSE) down

restart: down up ## –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

logs: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
	$(DOCKER_COMPOSE) logs -f

logs-rag: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ RAG —Å–µ—Ä–≤–∏—Å–∞
	$(DOCKER_COMPOSE) logs -f rag-service

logs-qdrant: ## –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ Qdrant
	$(DOCKER_COMPOSE) logs -f qdrant

clean: ## –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
	@echo "$(RED)–û—á–∏—Å—Ç–∫–∞ —Å–∏—Å—Ç–µ–º—ã...$(NC)"
	$(DOCKER_COMPOSE) down -v
	@sudo rm -rf qdrant_storage/*
	@echo "$(GREEN)–°–∏—Å—Ç–µ–º–∞ –æ—á–∏—â–µ–Ω–∞$(NC)"

health: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–∞
	@echo "$(GREEN)–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞...$(NC)"
	@python test_client.py --service-url $(SERVICE_URL)

info: ## –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
	@echo "$(GREEN)–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:$(NC)"
	@curl -s $(SERVICE_URL)/collection/info | python -m json.tool

test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ç–µ—Å—Ç
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞...$(NC)"
	@python test_client.py --test --service-url $(SERVICE_URL)

load-sample: ## –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö
	@echo "$(GREEN)–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö...$(NC)"
	@python data_loader.py --sample --service-url $(SERVICE_URL)

interactive: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –ø–æ–∏—Å–∫–∞
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ–∏—Å–∫–∞...$(NC)"
	@python test_client.py --interactive --service-url $(SERVICE_URL)

search: ## –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make search QUERY="–≤–∞—à –∑–∞–ø—Ä–æ—Å")
	@echo "$(GREEN)–ü–æ–∏—Å–∫: $(QUERY)$(NC)"
	@python test_client.py --query "$(QUERY)" --service-url $(SERVICE_URL)

load-json: ## –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON —Ñ–∞–π–ª–∞ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make load-json FILE=data.json)
	@echo "$(GREEN)–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ $(FILE)...$(NC)"
	@python data_loader.py --file $(FILE) --type json --service-url $(SERVICE_URL)

load-csv: ## –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–∞ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make load-csv FILE=data.csv COLUMN=text)
	@echo "$(GREEN)–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ $(FILE)...$(NC)"
	@python data_loader.py --file $(FILE) --type csv --text-column $(COLUMN) --service-url $(SERVICE_URL)

load-txt: ## –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ TXT —Ñ–∞–π–ª–∞ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: make load-txt FILE=data.txt)
	@echo "$(GREEN)–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ $(FILE)...$(NC)"
	@python data_loader.py --file $(FILE) --type txt --service-url $(SERVICE_URL)

clear-collection: ## –û—á–∏—Å—Ç–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
	@echo "$(YELLOW)–û—á–∏—Å—Ç–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏...$(NC)"
	@curl -X DELETE $(SERVICE_URL)/collection/clear

dev-install: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
	@echo "$(GREEN)–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏...$(NC)"
	@pip install -r requirements.txt

dev-run: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ Qdrant –∏ RAG —Å–µ—Ä–≤–∏—Å –ª–æ–∫–∞–ª—å–Ω–æ
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ Qdrant...$(NC)"
	@docker run -d --name qdrant-dev -p 6333:6333 -p 6334:6334 qdrant/qdrant:latest
	@echo "$(GREEN)–ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ Qdrant...$(NC)"
	@sleep 5
	@echo "$(GREEN)–ó–∞–ø—É—Å–∫ RAG —Å–µ—Ä–≤–∏—Å–∞...$(NC)"
	@QDRANT_HOST=localhost QDRANT_PORT=6333 python main.py

dev-stop: ## –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ
	@echo "$(YELLOW)–û—Å—Ç–∞–Ω–æ–≤–∫–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏—è...$(NC)"
	@docker stop qdrant-dev || true
	@docker rm qdrant-dev || true

status: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
	@echo "$(GREEN)–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:$(NC)"
	@$(DOCKER_COMPOSE) ps

setup: build up load-sample ## –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
	@echo "$(GREEN)‚úÖ RAG —Å–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ!$(NC)"
	@echo "$(YELLOW)üìä –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Qdrant: http://localhost:6333/dashboard$(NC)"
	@echo "$(YELLOW)üìö API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs$(NC)"
	@echo "$(YELLOW)üîç –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫: make interactive$(NC)"

# –ê–ª–∏–∞—Å—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
start: up
stop: down
reset: clean up